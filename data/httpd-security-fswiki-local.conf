### Security configuration of docker httpd
### including security headers and file accesses for
### https://github.com/KazKobara/dockerfile_fswiki_local

### Security Headers

## Against Signature
ServerTokens Prod
ServerSignature Off

## Against Clickjacking
# Header set X-Frame-Options SAMEORIGIN
Header always append X-Frame-Options DENY

## Against XSS
Header always set X-Content-Type-Options nosniff

## Against XST
TraceEnable Off

## CSP (Content Security Policy)
## NOTE: If different CSPs are set or added multiple times,
##   only the most strict policy seems to be set on certain environments,
##   such as httpd 2.4.52 of alpine and ubuntu.
##   In such cases, set the recommended CSP once here.
## Recommend CSP:
##   Allow only 'diffUsingJS(1);' and 
##  'document.getElementById("viewtype").addEventListener("click",function(){diffUsingJS(this.checked?0:1);});'
##  in the 'plugin/core/Diff.pm' (v3.6.5 + Diff.pm.patch)
##  without relying on 'unsafe-inline' or 'unsafe-hashes'.
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'sha256-BbejOj1mgweHq0Bq0xbe0JxDKZHGdgx+vU7h23Rb3ms=' 'sha256-7yauwBOy1wbSK3qiAwLRNJJdhRqtqzgtLClTapOB/4A=';"
## Not recommended CSPs:
## The first hash value is of 'diffUsingJS(this.checked?0:1);' in the 'onclick' event handler in a space-new-line-removed Diff.pm.
# Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-hashes' 'sha256-Zm4N7k+/oEZUqWHLlEwkbC9NA4YO5zNbJv0N0E2zv5c=' 'sha256-7yauwBOy1wbSK3qiAwLRNJJdhRqtqzgtLClTapOB/4A=';"
# Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline';"
# Header always set Content-Security-Policy "default-src 'self';"

### File Access
<FilesMatch "\..*">
    deny from all
</FilesMatch>

### Directory Specific Configuration
### for File Access and Security Headers
<Directory /usr/local/apache2/htdocs/>
    <FilesMatch "(wiki.cgi|favicon.ico)">
        allow from all
    </FilesMatch>
</Directory>

<DirectoryMatch "^/usr/local/apache2/htdocs/(?!theme/).*/">
    # Reset parent settings except 'theme'
    <FilesMatch "\..*">
        deny from all
    </FilesMatch>
</DirectoryMatch>

<Directory /usr/local/apache2/htdocs/theme/>
    <FilesMatch "\..*">
        deny from all
    </FilesMatch>
    # Reset parent settings, then
    <FilesMatch "\.(css|jpe?g|gif|png)$">
        allow from all
    </FilesMatch>
</Directory>

<Directory /usr/local/apache2/htdocs/theme/resources/>
    ## NOTE: If different CSPs are set or added multiple times,
    ##   only the most strict policy seems to be set on certain environments,
    ##   such as httpd 2.4.52 of alpine and ubuntu.
    ##   In such cases, set the above recommended CSP once.
    <FilesMatch "\.(js)$">
        allow from all
    </FilesMatch>
</Directory>
