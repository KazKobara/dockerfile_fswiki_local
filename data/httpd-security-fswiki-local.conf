### Security configuration of docker httpd
### including security headers and file accesses for
### https://github.com/KazKobara/dockerfile_fswiki_local

### Security Headers

## Against Signature
ServerTokens Prod
ServerSignature Off

## Against Clickjacking
# Header set X-Frame-Options SAMEORIGIN
Header always append X-Frame-Options DENY

## Against XSS
Header always set X-Content-Type-Options nosniff

## Against XST
TraceEnable Off

## CSP (Content Security Policy)
## NOTE: If different CSPs are set or added multiple times,
##   only the most strict policy seems to be set on certain environments,
##   such as httpd 2.4.52 of alpine and ubuntu.
##   In such cases, set the recommended CSP once here.
##
## Recommended CSP:
## Drawback is, however, it blocks displaying inline 'text-align' in Markdown table generated by Markdown Plugin.
## TODO: Modify markdown-to-html converter, such as Discount, not to use inline styles.
##
Header always set Content-Security-Policy "default-src 'self'; object-src 'none'; child-src 'none'; style-src 'self'; script-src 'self' 'sha256-BbejOj1mgweHq0Bq0xbe0JxDKZHGdgx+vU7h23Rb3ms=' 'sha256-7yauwBOy1wbSK3qiAwLRNJJdhRqtqzgtLClTapOB/4A=';"
##
## Next-recommended CSP:
##  "style-src 'unsafe-hashes'" is for 'text-align' in Markdown table.
##
#Header always set Content-Security-Policy "default-src 'self'; object-src 'none'; child-src 'none';\
#  style-src 'self' 'unsafe-hashes' \
#    'sha256-BBOGexNnujshehIQ4WlkijzyT1OZDSFMwde8dE1r6DE=' \
#    'sha256-Wi3+8jbn12vus9Oq4FOqEUCOpuRG3clBaVvLZZ2b9Fs=' \
#    'sha256-m3XTiIF20AAl/JoLbhZCLpVDCCo+QhhIqpqq9SZ30Dk=';\
#  script-src 'self' \
#    'sha256-BbejOj1mgweHq0Bq0xbe0JxDKZHGdgx+vU7h23Rb3ms=' \
#    'sha256-7yauwBOy1wbSK3qiAwLRNJJdhRqtqzgtLClTapOB/4A=';"
##
##
## CSP Hashes (<hash-algorithm>-<base64-value>) of <input> calculated by:
##   $ echo -n '<input>' | openssl sha256 -binary | openssl base64
##
##   For style-src:
##    in tables and so on generated by ./plugin/markdown/Markdown.pm.
##    'text-align:left;'
##      'sha256-BBOGexNnujshehIQ4WlkijzyT1OZDSFMwde8dE1r6DE='
##    'text-align:center;'
##      'sha256-Wi3+8jbn12vus9Oq4FOqEUCOpuRG3clBaVvLZZ2b9Fs='
##    'text-align:right;'
##      'sha256-m3XTiIF20AAl/JoLbhZCLpVDCCo+QhhIqpqq9SZ30Dk='
##
##   For script-src:
##    diffview generated by ./theme/resources/diff.js and ./plugin/core/Diff.pm (v3.6.5 + Diff.pm.patch)
##    'diffUsingJS(1);'
##      'sha256-7yauwBOy1wbSK3qiAwLRNJJdhRqtqzgtLClTapOB/4A='
##    'document.getElementById("viewtype").addEventListener("click",function(){diffUsingJS(this.checked?0:1);});'
##    in the 'plugin/core/Diff.pm' (v3.6.5 + Diff.pm.patch)
##      'sha256-BbejOj1mgweHq0Bq0xbe0JxDKZHGdgx+vU7h23Rb3ms='
##
## Not recommended CSPs:
##
## Diffview and 'text-align' in Markdown table do not work.
# Header always set Content-Security-Policy "default-src 'self';"
##
## The following CSPs are for debugging. 
# Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'sha256-BbejOj1mgweHq0Bq0xbe0JxDKZHGdgx+vU7h23Rb3ms=' 'sha256-7yauwBOy1wbSK3qiAwLRNJJdhRqtqzgtLClTapOB/4A=';"
# Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-hashes' 'sha256-Zm4N7k+/oEZUqWHLlEwkbC9NA4YO5zNbJv0N0E2zv5c=' 'sha256-7yauwBOy1wbSK3qiAwLRNJJdhRqtqzgtLClTapOB/4A=';"
# Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline';"

### File Access
<FilesMatch "\..*">
    deny from all
</FilesMatch>

### Directory Specific Configuration
### for File Access and Security Headers
<Directory /usr/local/apache2/htdocs/>
    <FilesMatch "(wiki.cgi|favicon.ico)">
        allow from all
    </FilesMatch>
</Directory>

<DirectoryMatch "^/usr/local/apache2/htdocs/(?!theme/).*/">
    # Reset parent settings except 'theme'
    <FilesMatch "\..*">
        deny from all
    </FilesMatch>
</DirectoryMatch>

<Directory /usr/local/apache2/htdocs/theme/>
    <FilesMatch "\..*">
        deny from all
    </FilesMatch>
    # Reset parent settings, then
    <FilesMatch "\.(css|jpe?g|gif|png)$">
        allow from all
    </FilesMatch>
</Directory>

<Directory /usr/local/apache2/htdocs/theme/resources/>
    ## NOTE: If different CSPs are set or added multiple times,
    ##   only the most strict policy seems to be set on certain environments,
    ##   such as httpd 2.4.52 of alpine and ubuntu.
    ##   In such cases, set the above recommended CSP once.
    <FilesMatch "\.(js)$">
        allow from all
    </FilesMatch>
</Directory>
